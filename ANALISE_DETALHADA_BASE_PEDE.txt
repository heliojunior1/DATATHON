# üìä An√°lise Detalhada da Base PEDE ‚Äî Features, Normaliza√ß√£o e Dados Faltantes

---

## TL;DR

A base possui **3 abas** (PEDE2022: 860 alunos √ó 42 colunas, PEDE2023: 1014 √ó 48, PEDE2024: 1156 √ó 50) em formato wide. O target atual √© `risco_defasagem` (bin√°rio, derivado de `Defas <= 0`). Existem **27 features** selecionadas no pipeline atual, mas h√° problemas cr√≠ticos:

- **IAN** causa **data leakage** (correla√ß√£o 0.838 com o target)
- **Ingl√™s** tem **67% de nulos**. Siga sua "Op√ß√£o A" (Remover a coluna de nota), mas mantenha a feature derivada Tem_nota_ingles (bin√°ria), pois o simples fato de ter aula de ingl√™s pode indicar uma turma ou fase mais avan√ßada/estruturad
- **Pedra 20** tem **62% de nulos**
- V√°rios indicadores t√™m distribui√ß√µes assim√©tricas (IAA skew = **-2.91**)

Abaixo, a an√°lise completa com recomenda√ß√µes.

---

## 1. Invent√°rio Completo de Colunas (PEDE2022 ‚Äî base de treino)

### A) Indicadores Educacionais (escala 0‚Äì10)

| Coluna | Descri√ß√£o | Nulos | Distribui√ß√£o | A√ß√£o |
|--------|-----------|-------|--------------|------|
| **INDE 22** | √çndice de Desenvolvimento Educacional (composto) | 0% | Œº=7.04, œÉ=1.02 | ‚úÖ **USAR** ‚Äî feature principal |
| **IAA** | Auto-Avalia√ß√£o | 0% | Œº=8.27, œÉ=2.06, **skew=-2.91** | ‚úÖ **USAR** ‚Äî precisa normaliza√ß√£o |
| **IEG** | Engajamento (entrega de li√ß√µes) | 0% | Œº=7.89, œÉ=1.64, skew=-1.10 | ‚úÖ **USAR** ‚Äî precisa normaliza√ß√£o |
| **IPS** | Psicossocial | 0% | Œº=n√£o informado | ‚úÖ **USAR** |
| **IDA** | Aprendizagem (m√©dia de provas) | 0% | Œº=6.09, œÉ=2.05 | ‚úÖ **USAR** ‚Äî correla√ß√£o 0.83‚Äì0.90 com notas |
| **IPV** | Ponto de Virada | 0% | cont√≠nuo 0‚Äì10 | ‚úÖ **USAR** |
| **IAN** | Adequa√ß√£o ao N√≠vel (discreto: 0, 5 ou 10) | 0% | Œº=6.42, œÉ=2.39 | ‚ùå usar uma flag para remover ‚Äî leakage (corr 0.838 com Defas) |

### B) Notas por Disciplina

| Coluna | Nulos | A√ß√£o |
|--------|-------|------|
| **Matem** | 0.23% (2 alunos) | ‚úÖ **USAR** ‚Äî imputar com mediana |
| **Portug** | 0.23% (2 alunos) | ‚úÖ **USAR** ‚Äî imputar com mediana |
| **Ingl√™s** | **67.09%** (577 alunos) | Siga sua "Op√ß√£o A" (Remover a coluna de nota), mas mantenha a feature derivada Tem_nota_ingles (bin√°ria), pois o simples fato de ter aula de ingl√™s pode indicar uma turma ou fase mais avan√ßada/estruturad

| **Fase** | 0% | ‚úÖ **USAR** ‚Äî encode ordinal num√©rico (ver detalhes abaixo) |

> **üìù Esclarecimento sobre a Fase:**
> A `Fase` isoladamente **n√£o √© data leakage** ‚Äî ela representa o contexto de progress√£o escolar do aluno (em qual etapa do programa ele est√°). O **vazamento real** ocorre ao combinar `Fase` com `Fase Ideal`, pois essa diferen√ßa **√©** a vari√°vel target (`Defas = Fase - Fase Ideal`). Como `Fase Ideal` j√° est√° na lista de remo√ß√£o (se√ß√£o G), manter a `Fase` √© seguro.
>
> **Encoding recomendado** ‚Äî ordinal num√©rico (n√£o One-Hot):
>
> | Fase | Encoding |
> |------|----------|
> | Alfa | 0 |
> | Fase 1 | 1 |
> | Fase 2 | 2 |
> | Fase 3 | 3 |
> | Fase 4 | 4 |
> | Fase 5 | 5 |
> | Fase 6 | 6 |
> | Fase 7 | 7 |
> | Fase 8 | 8 |
>
> **Por que ordinal e n√£o One-Hot?**
> - As fases t√™m **ordem natural** (progress√£o escolar): Alfa < Fase 1 < Fase 2 < ... < Fase 8
> - One-Hot criaria **9 colunas** bin√°rias, perdendo a rela√ß√£o ordinal e inflando a dimensionalidade
> - Encoding ordinal preserva a informa√ß√£o de que `Fase 5 > Fase 3` em uma **√∫nica coluna**
> - XGBoost e modelos de √°rvore aproveitam bem a ordena√ß√£o natural para fazer splits eficientes




### D) Classifica√ß√µes Pedra (ordinal: Quartzo ‚Üí Top√°zio)

| Coluna | Nulos | A√ß√£o |
|--------|-------|------|
| **Pedra 22** | 0% | ‚úÖ **USAR** ‚Äî encode ordinal |
| **Pedra 21** | **46.28%** | ‚úÖ **USAR** ‚Äî XGBoost lida com NaN nativo |
| **Pedra 20** | **62.44%** | ‚ö†Ô∏è **USAR COM CAUTELA** ‚Äî muitos NaN, mas permite calcular evolu√ß√£o |

### E) Rankings

| Coluna | Nulos | A√ß√£o |
|--------|-------|------|
| **Cg** (global) | 0% | Manter. Apesar de observar alta correla√ß√£o -0.959 com INDE 22 = redund√¢ncia total

| **Cf** (fase) | 0% | ‚úÖ **MANTER** ‚Äî ranking relativo √† fase, n√£o redundante |
| **Ct** (turma) | 0% | ‚úÖ **MANTER** |
| **N¬∫ Av** (n¬∫ avalia√ß√µes) | 0% | ‚úÖ **MANTER** |

### F) Recomenda√ß√µes e Flags

| Coluna | Nulos | A√ß√£o |
|--------|-------|------|
| **Rec Psicologia** | remover , ja tem dados do ips . Apesar de ter dados definidos em 2022  4 categorias ordin√°veis (`N√£o indicado`=0, `Sem limita√ß√µes`=1, `Requer avalia√ß√£o`=2, `N√£o atendido`=3). Decidi remover 
| **Atingiu PV** | 0% | ‚úÖ **USAR** ‚Äî flag bin√°ria |
| **Indicado** (bolsa) | 0% | ‚úÖ **USAR** ‚Äî flag bin√°ria |
| **Rec Av1** | 0% | ‚úÖ **USAR** ‚Äî encode ordinal |
| **Rec Av2** | ~0% | ‚úÖ **USAR** ‚Äî encode ordinal |
| **Rec Av3** | **37.91%** | ‚ö†Ô∏è **AVALIAR** ‚Äî muitos NaN |
| **Rec Av4** | **64-66%** | ‚ùå **REMOVER** ‚Äî NaN demais |
| **Avaliador 1-4** | vari√°vel | ‚ùå **REMOVER** ‚Äî nomes, n√£o features preditivas |
| **Destaque IEG/IDA/IPV** | 0% | ‚úÖ **USAR** ‚Äî converter para flag bin√°ria ("Destaque" vs "Melhorar") |

### G) Identificadores e Derivadas do Target

| Coluna | A√ß√£o |
|--------|------|
| **RA**, **Nome**, **Turma** | ‚ùå **REMOVER** ‚Äî identificadores |
| **Defas** | ‚ùå **REMOVER** ‚Äî √© a vari√°vel fonte do target |
| **Fase ideal** | ‚ùå **REMOVER** ‚Äî componente direto de Defas |

---

## 2. Features que Precisam de Normaliza√ß√£o

| Feature | Tipo | Problema | Normaliza√ß√£o Recomendada |
|---------|------|----------|--------------------------|
| **IAA** | Cont√≠nua 0‚Äì10 | Skewness = **-2.91** (forte assimetria √† esquerda) | `PowerTransformer(method='yeo-johnson')` + `StandardScaler` |
| **IEG** | Cont√≠nua 0‚Äì10 | Skewness = **-1.10** | `StandardScaler` (suficiente) |
| **IDA** | Cont√≠nua 0‚Äì10 | œÉ=2.05, distribui√ß√£o razo√°vel | `StandardScaler` |
| **IPS** | Cont√≠nua 0‚Äì10 | Verificar skewness | `StandardScaler` |
| **IPV** | Cont√≠nua 0‚Äì10 | Verificar skewness | `StandardScaler` |
| **INDE 22** | Cont√≠nua ~3‚Äì9.5 | œÉ=1.02, bem concentrada | `StandardScaler` |
| **Matem, Portug** | Cont√≠nua 0‚Äì10 | Distribui√ß√£o normal approx. | `StandardScaler` |
| **Idade 22** | Inteira 7‚Äì18+ | Escala diferente dos √≠ndices | `StandardScaler` |
| **Cg, Cf, Ct** | Rankings inteiros | Escala 1‚Äì860 | `StandardScaler` ou `MinMaxScaler` |

> **Nota importante**: Para **XGBoost**, normaliza√ß√£o **n√£o √© estritamente necess√°ria** ‚Äî modelos baseados em √°rvore s√£o invariantes √† escala. A normaliza√ß√£o seria relevante se usar modelos lineares, SVM, ou redes neurais como alternativa/ensemble.Porem irei implementar normalizacao, pois predento utilizar outros modelos 

---

## 3. Colunas com Muitos Dados Faltantes ‚Äî Diagn√≥stico e A√ß√£o

| Coluna | % Nulos | Causa Raiz | Recomenda√ß√£o |
|--------|---------|-----------|--------------|
| **Ingl√™s** | **67.09%** | S√≥ avaliada para alunos de fases mais avan√ßadas | **Op√ß√£o A**: Remover (mais seguro). **Op√ß√£o B**: rem,moover |
| **Rec Av4 / Avaliador4** | **64-66%** | Nem todos os alunos t√™m 4 avaliadores | **Remover** ‚Äî informa√ß√£o escassa |
| **Pedra 20** | **62.44%** | Alunos que ingressaram ap√≥s 2020 | **Manter NaN** ‚Äî XGBoost trata nativamente. Usar para calcular `Evolucao_pedra_20_22` |
| **Pedra 21** | **46.28%** | Alunos que ingressaram ap√≥s 2021 | **Manter NaN** ‚Äî mesma estrat√©gia acima |
| **Rec Av3** | **37.91%** | Nem todos os alunos t√™m 3 avaliadores | **Avaliar**: se feature importance baixa, remover |

---

## 4. ‚ö†Ô∏è Problema Cr√≠tico: Data Leakage com IAN

A feature **IAN** (Indicador de Adequa√ß√£o ao N√≠vel) tem correla√ß√£o **0.838** com `Defas` (target) e contribui com **58.4% da import√¢ncia** do modelo. Isso ocorre porque:

- IAN mede se o aluno est√° no n√≠vel adequado ‚Üí √© **praticamente sin√¥nimo** da defasagem
- IAN discreto (0, 5, 10) classifica: `0 = n√£o adequado`, `5 = parcial`, `10 = adequado`
- O modelo atual com IAN tem AUC 98.47% ‚Äî **inflado por leakage**

**Recomenda√ß√£o**: Treinar **dois modelos** (j√° previsto em `config.py` com `SELECTED_FEATURES_NO_IAN`) e comparar. O modelo **sem IAN** ser√° mais honesto e generaliz√°vel.Coloca como padrao a flag no ian como true 

---


## 4.1 üéØ Defini√ß√£o do Target: Diagn√≥stico vs. Preven√ß√£o

### O dilema: quando alertar a ONG?

A defini√ß√£o do **threshold de defasagem** para o target bin√°rio √© a decis√£o mais impactante do projeto, pois determina **quando** o sistema dispara um alerta de risco.

### Cen√°rio 1: Abordagem "Atraso Grave" (implementa√ß√£o atual)

```
Target = 1 se Defasagem <= -2
```

| Defasagem | Classifica√ß√£o | Significado |
|-----------|--------------|-------------|
| 0, +1, +2 | Sem Risco (0) | Aluno na trilha ou adiantado |
| **-1** | **Sem Risco (0)** ‚ùå | Aluno repetiu 1 ano ‚Äî **ignorado pelo modelo** |
| -2, -3 | Em Risco (1) | Aluno com atraso grave ‚Äî alerta tardio |

**Problema**: Um aluno que estava indo bem (`Defas = 0`) e repetiu pela primeira vez (`Defas = -1`) √© classificado como **"Sem Risco"**. O modelo s√≥ alerta quando o atraso j√° √© **grave e dif√≠cil de reverter**.

### Cen√°rio 2: Abordagem Preventiva (recomendada) ‚úÖ

```
Target = 1 se Defasagem < 0 (ou seja, -1, -2, -3...)
```

| Defasagem | Classifica√ß√£o | Significado |
|-----------|--------------|-------------|
| 0, +1, +2 | Sem Risco (0) | Aluno na trilha ou adiantado |
| **-1** | **Em Risco (1)** ‚úÖ | Aluno saiu da trilha ‚Äî **alerta precoce** |
| -2, -3 | Em Risco (1) | Aluno com atraso grave ‚Äî tamb√©m capturado |

**Ganho**: Permite interven√ß√£o **r√°pida**. √â muito mais f√°cil recuperar um aluno com 1 ano de atraso do que um com 2 ou 3.

### Compara√ß√£o de impacto

| Aspecto | Threshold ‚â§ -2 (atual) | Threshold < 0 (preventivo) |
|---------|------------------------|---------------------------|
| **Filosofia** | Diagn√≥stico tardio | Preven√ß√£o precoce |
| **Alunos com Defas = -1** | Ignorados ‚ùå | Capturados ‚úÖ |
| **% de positivos (estimado)** | ~15-20% | ~30-40% |
| **Balanceamento de classes** | Mais desbalanceado | Mais equilibrado |
| **Recall esperado** | Alto para graves, zero para leves | Alto para todos |
| **Falsos positivos** | Poucos | Mais (aceit√°vel: melhor alertar do que ignorar) |
| **Utilidade para a ONG** | Reativo: "o aluno j√° est√° atrasado" | Proativo: "o aluno est√° come√ßando a atrasar" |
| **Custo do erro (FN)** | Alto: aluno com -1 n√£o recebe ajuda | Baixo: aluno com -1 recebe ajuda preventiva |

### Decis√£o: **Adotar threshold preventivo (`Defas < 0`)**

**Justificativa**:

1. **Alinhamento com a miss√£o da ONG**: A Passos M√°gicos busca **transformar** vidas ‚Äî intervir cedo √© mais eficaz
2. **Custo assim√©trico**: O custo de **n√£o alertar** (falso negativo) √© muito maior que o custo de **alertar desnecessariamente** (falso positivo). Um aluno que recebe suporte extra sem precisar n√£o √© prejudicado; um aluno que precisava e n√£o recebeu pode abandonar os estudos
3. **Melhor balanceamento**: ~30-40% de positivos vs ~15-20% reduz a necessidade de t√©cnicas agressivas de oversampling
4. **Captura tend√™ncia**: Um aluno com `Defas = -1` est√° em **trajet√≥ria descendente** ‚Äî o modelo preventivo captura isso antes que se agrave


## 5. Features Derivadas Recomendadas (al√©m das existentes)

| Feature | F√≥rmula | Justificativa |
|---------|---------|---------------|
| `Anos_na_PM` | `2022 - Ano ingresso` | ‚úÖ **J√° implementada** em `feature_engineering.py` |
| `Evolucao_pedra_20_22` | `Pedra_22_enc - Pedra_20_enc` | ‚úÖ **J√° implementada** |
| `Evolucao_pedra_21_22` | `Pedra_22_enc - Pedra_21_enc` | ‚úÖ **J√° implementada** |

| `Variancia_indicadores` | `std(IAA, IEG, IPS, IDA, IPV)` | üÜï **Nova** ‚Äî alunos com desempenho irregular |
| `Ratio_IDA_IEG` | `IDA / (IEG + 0.01)` | üÜï **Nova** ‚Äî desempenho vs esfor√ßo |

| `Delta_INDE` (cross-year) | `INDE_22 - INDE_21` | üÜï **Nova** ‚Äî tend√™ncia do aluno (requer join entre abas) |
| **`mismatch_idade_fase`** | `1 se Idade > idade_max_esperada(Fase)` | ‚úÖ **Nova** ‚Äî flag bin√°ria que identifica alunos com idade acima do esperado para sua fase. Indicador direto de atraso escolar |
| **`delta_idade_fase`** | `Idade - idade_max_esperada(Fase)` | ‚úÖ **Nova** ‚Äî vers√£o cont√≠nua do mismatch, captura a **severidade** do atraso (ex: +1 ano vs +3 anos). Valores positivos = atraso, zero/negativos = ok |

---

## 6. Resumo das Decis√µes-Chave

### üìã Steps de implementa√ß√£o sugeridos

1. **Remover**  `Defas`, `Fase ideal`, `RA`, `Nome`, `Turma`, `Avaliador1-4`, `Rec Av3`, `Rec Av4`
2. **Tratar Ingl√™s**: remover coluna OU criar flag `tem_nota_ingles` + manter NaN
3. **Imputar** `Matem` e `Portug` com mediana (apenas 2 nulos cada)
4. **Pedras hist√≥ricas**: Encode ordinal (Quartzo=1, √Ågata=2, Ametista=3, Top√°zio=4). Aplicar estrat√©gia **"Delta Neutro com Flag"**: criar flags `tinha_pedra_20` e `tinha_pedra_21`, for√ßar delta a `0` para alunos sem hist√≥rico (evitar infla√ß√£o artificial), imputar Pedra bruta com `0`
5. **Normalizar** IAA com `PowerTransformer` (skew -2.91); demais num√©ricas com `StandardScaler` ‚Äî necess√°rio apenas se usar modelos lineares/ensemble com regress√£o log√≠stica
6. **Encode ordinal**: Pedra (Quartzo=1‚ÜíTop√°zio=4), Fase (Alfa=0‚ÜíFase 8=8), Rec Av1/Av2 (j√° implementado em `preprocessing.py`)
7. **Encode bin√°rio**: G√™nero, Atingiu PV, Indicado, Destaques (j√° implementado)
8. **Criar features derivadas** novas: 
9.  **Treinar modelo sem IAN** como modelo principal e comparar performance

### ‚úÖ Verifica√ß√£o

- Comparar AUC-ROC e F1 do modelo **com vs sem IAN**
- Verificar feature importance das novas features derivadas
- Validar que nenhuma feature restante tem correla√ß√£o > 0.80 com o target (al√©m do INDE)
- Rodar `python train_pipeline.py` para retreinar e verificar m√©tricas

### üß≠ Decis√µes T√©cnicas

- **XGBoost n√£o requer normaliza√ß√£o**, mas se for testar ensemble com modelos lineares, aplicar `StandardScaler` + `PowerTransformer` para IAA
- **IAN  colocar uma flag para inicialmente iniciar com ian desativo para evitar  data leakage
- **Ingl√™s**: remover √© mais conservador; manter com flag √© mais informativo mas arriscado com 67% NaN
- **Rankings** `Cf` e `Ct` mantidos por trazerem informa√ß√£o relativa (posi√ß√£o dentro do grupo), diferente de `Cg` que √© diretamente derivado de INDE
> **‚ö†Ô∏è Alerta para Produ√ß√£o (API) ‚Äî Rankings de alunos novos:**
>
> Nos dados de treino (PEDE2022‚Äì2024), **Cf e Ct t√™m 0% de nulos** porque todos os alunos j√° foram avaliados e ranqueados. Por√©m, em **produ√ß√£o (API 2025+)**, alunos **entrantes/novos** ainda n√£o ter√£o ranking atribu√≠do.
>
> | Cen√°rio | Cf / Ct | Problema |
> |---------|---------|----------|
> | **Treino** (2022‚Äì2024) | Sempre preenchido | Nenhum ‚Äî dados completos |
> | **Produ√ß√£o** (2025+) | **NaN para alunos novos** | Modelo recebe input que nunca viu no treino ‚Üí **pode quebrar ou gerar predi√ß√£o errada** |
>
> **Estrat√©gia recomendada: "Fallback com Flag"**
>
> 1. **Criar flags** `tem_ranking_cf` e `tem_ranking_ct` (1 = tem, 0 = aluno novo)
> 2. **Imputar NaN** com valor neutro: **mediana da fase/turma** ou valor **-1** (fora da escala natural)
> 3. **Injetar NaN artificial no treino**: durante o treinamento, for√ßar ~10-15% dos rankings a NaN aleatoriamente para que o modelo aprenda a lidar com a aus√™ncia
>


Causa Raiz
A coluna Defas (nosso target) √© definida como Defas = Fase - Fase Ideal ‚Äî mede a diferen√ßa entre a fase atual e a fase ideal baseada na idade.

As features 

delta_idade_fase
 e 

mismatch_idade_fase
 que criamos fazem exatamente a mesma coisa: comparam idade com a fase esperada. S√£o proxies diretos do target.

Correla√ß√µes com o Target
Feature	Correla√ß√£o	Status

delta_idade_fase
0.708	üî¥ LEAKAGE

mismatch_idade_fase
0.553	üî¥ LEAKAGE
Idade 22	0.277	‚ö†Ô∏è Contribui junto com Fase
Pedra_22_encoded	-0.377	‚úÖ OK
INDE 22	-0.369	‚úÖ OK
Cf / Ct	0.36 / 0.34	‚úÖ OK
Plano de Corre√ß√£o
Remover 

delta_idade_fase
 e 

mismatch_idade_fase
 de SELECTED_FEATURES ‚Äî s√£o proxies do target
Manter Idade 22 e Fase_encoded isoladamente ‚Äî cada uma sozinha tem correla√ß√£o aceit√°vel, o leakage ocorre na combina√ß√£o (delta)
Retreinar o modelo sem --no-optimize
Esperar m√©tricas mais realistas (provavelmente 75-85% accuracy)